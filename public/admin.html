<!DOCTYPE html>
<html lang="tr">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>YÃ¶netici Paneli - Dijital KÃ¼tÃ¼phane</title>
    <link href="/styles.css" rel="stylesheet" />
    <style>
      .active-nav {
        background-color: #1e293b;
        border-right: 4px solid #3b82f6;
      }
    </style>
  </head>

  <body class="bg-gray-100 font-sans">
    <div class="flex h-screen overflow-hidden">
      <aside class="w-64 bg-slate-900 text-white flex flex-col shadow-2xl">
        <div
          class="h-16 flex items-center justify-center border-b border-slate-700"
        >
          <i class="fas fa-shield-alt text-blue-500 text-2xl mr-2"></i>
          <span class="font-bold text-xl">Admin Paneli</span>
        </div>

        <nav class="flex-1 py-6 space-y-1">
          <button
            onclick="showSection('dashboard')"
            id="btn-dashboard"
            class="w-full text-left px-6 py-3 hover:bg-slate-800 transition flex items-center active-nav"
          >
            <i class="fas fa-chart-line w-6"></i> Genel BakÄ±ÅŸ
          </button>
          <button
            onclick="showSection('books')"
            id="btn-books"
            class="w-full text-left px-6 py-3 hover:bg-slate-800 transition flex items-center"
          >
            <i class="fas fa-book w-6"></i> Kitap YÃ¶netimi
          </button>
          <button
            onclick="showSection('users')"
            id="btn-users"
            class="w-full text-left px-6 py-3 hover:bg-slate-800 transition flex items-center"
          >
            <i class="fas fa-users w-6"></i> KullanÄ±cÄ± YÃ¶netimi
          </button>
        </nav>

        <div class="p-4 border-t border-slate-700">
          <button
            onclick="logout()"
            class="w-full bg-red-600 hover:bg-red-700 text-white py-2 rounded flex items-center justify-center transition"
          >
            <i class="fas fa-sign-out-alt mr-2"></i> Ã‡Ä±kÄ±ÅŸ Yap
          </button>
        </div>
      </aside>

      <main class="flex-1 overflow-y-auto p-8">
        <header class="flex justify-between items-center mb-8">
          <div class="flex items-center gap-4">
            <h2 id="page-title" class="text-3xl font-bold text-gray-800">
              Genel BakÄ±ÅŸ
            </h2>
            <a
              href="index.html"
              class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded flex items-center gap-2 transition"
            >
              <i class="fas fa-home"></i> Ana Sayfa
            </a>
          </div>
          <div class="flex items-center gap-3">
            <div class="text-right hidden sm:block">
              <p id="admin-name" class="text-sm font-bold text-gray-900">
                YÃ¶netici
              </p>
              <p id="admin-email" class="text-xs text-gray-500">-</p>
            </div>
            <div
              class="w-10 h-10 bg-slate-900 rounded-full flex items-center justify-center text-white"
            >
              <i class="fas fa-user-cog"></i>
            </div>
          </div>
        </header>

        <div id="section-dashboard" class="space-y-6">
          <div class="grid grid-cols-1 md:grid-cols-4 gap-6">
            <div
              class="bg-white p-6 rounded-lg shadow-sm border-l-4 border-blue-500"
            >
              <div class="flex justify-between items-center">
                <div>
                  <p class="text-gray-500 text-sm">Toplam Kitap</p>
                  <h3 id="stat-books" class="text-2xl font-bold">-</h3>
                </div>
                <i class="fas fa-book text-blue-500 text-3xl"></i>
              </div>
            </div>
            <div
              class="bg-white p-6 rounded-lg shadow-sm border-l-4 border-green-500"
            >
              <div class="flex justify-between items-center">
                <div>
                  <p class="text-gray-500 text-sm">Aktif KullanÄ±cÄ±</p>
                  <h3 id="stat-users" class="text-2xl font-bold">-</h3>
                </div>
                <i class="fas fa-users text-green-500 text-3xl"></i>
              </div>
            </div>
            <div
              class="bg-white p-6 rounded-lg shadow-sm border-l-4 border-yellow-500"
            >
              <div class="flex justify-between items-center">
                <div>
                  <p class="text-gray-500 text-sm">Toplam GÃ¶nderi</p>
                  <h3 id="stat-posts" class="text-2xl font-bold">-</h3>
                </div>
                <i class="fas fa-pen text-yellow-500 text-3xl"></i>
              </div>
            </div>
            <div
              class="bg-white p-6 rounded-lg shadow-sm border-l-4 border-purple-500"
            >
              <div class="flex justify-between items-center">
                <div>
                  <p class="text-gray-500 text-sm">Toplam Yorum</p>
                  <h3 id="stat-comments" class="text-2xl font-bold">-</h3>
                </div>
                <i class="fas fa-comments text-purple-500 text-3xl"></i>
              </div>
            </div>
          </div>
        </div>

        <div id="section-books" class="hidden">
          <div class="flex justify-between mb-4">
            <div class="relative w-64">
              <input
                type="text"
                id="book-search-admin"
                placeholder="Kitap ara..."
                class="w-full border rounded pl-8 pr-2 py-2 text-sm focus:outline-none focus:border-blue-500"
                oninput="searchBooksAdmin()"
              />
              <i
                class="fas fa-search absolute left-2.5 top-3 text-gray-400 text-xs"
              ></i>
            </div>
            <button
              onclick="kitapEkleModal()"
              class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded text-sm font-bold flex items-center"
            >
              <i class="fas fa-plus mr-2"></i> Yeni Kitap Ekle
            </button>
          </div>

          <div class="bg-white rounded-lg shadow overflow-hidden">
            <table class="w-full text-left border-collapse">
              <thead class="bg-gray-50 text-gray-600 text-xs uppercase">
                <tr>
                  <th class="p-4 border-b">Kapak</th>
                  <th class="p-4 border-b">ID</th>
                  <th class="p-4 border-b">Kitap AdÄ±</th>
                  <th class="p-4 border-b">Yazar</th>
                  <th class="p-4 border-b">Kategori</th>
                  <th class="p-4 border-b text-center">Ä°ÅŸlemler</th>
                </tr>
              </thead>
              <tbody id="books-table-body" class="text-sm"></tbody>
            </table>
          </div>
        </div>

        <div id="section-users" class="hidden">
          <div class="bg-white rounded-lg shadow overflow-hidden">
            <table class="w-full text-left border-collapse">
              <thead class="bg-gray-50 text-gray-600 text-xs uppercase">
                <tr>
                  <th class="p-4 border-b">KullanÄ±cÄ±</th>
                  <th class="p-4 border-b">E-posta</th>
                  <th class="p-4 border-b">Rol</th>
                  <th class="p-4 border-b">Durum</th>
                  <th class="p-4 border-b text-center">Ä°ÅŸlemler</th>
                </tr>
              </thead>
              <tbody id="users-table-body" class="text-sm"></tbody>
            </table>
          </div>
        </div>

        </div>
      </main>
    </div>

    <div id="add-book-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 items-center justify-center z-50">
      <div class="bg-white rounded-lg shadow-xl w-full max-w-md mx-4">
        <div class="flex justify-between items-center p-6 border-b">
          <h3 class="text-xl font-bold text-gray-800">Yeni Kitap Ekle</h3>
          <button onclick="closeAddBookModal()" class="text-gray-500 hover:text-gray-700 text-2xl">&times;</button>
        </div>
        <form id="add-book-form" class="p-6 space-y-4 max-h-[70vh] overflow-y-auto">
          <div>
            <label class="block text-sm font-semibold text-gray-700 mb-2">Kitap AdÄ± *</label>
            <input type="text" id="book-title" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-blue-500" placeholder="Kitap adÄ±nÄ± girin">
          </div>
          <div>
            <label class="block text-sm font-semibold text-gray-700 mb-2">Yazar(lar) *</label>
            <input type="text" id="book-author" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-blue-500" placeholder="Birden fazla yazar iÃ§in virgÃ¼l ile ayÄ±rÄ±n">
          </div>
          <div>
            <label class="block text-sm font-semibold text-gray-700 mb-2">Kategori *</label>
            <input type="text" id="book-category" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-blue-500" placeholder="Kategori girin">
          </div>
          <div>
            <label class="block text-sm font-semibold text-gray-700 mb-2">YayÄ±nevi *</label>
            <input type="text" id="book-publisher" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-blue-500" placeholder="YayÄ±nevi adÄ±nÄ± girin">
          </div>
          <div>
            <label class="block text-sm font-semibold text-gray-700 mb-2">Sayfa SayÄ±sÄ± *</label>
            <input type="number" id="book-page-count" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-blue-500" placeholder="Sayfa sayÄ±sÄ±nÄ± girin">
          </div>
          <div>
            <label class="block text-sm font-semibold text-gray-700 mb-2">KÄ±sa AÃ§Ä±klama *</label>
            <textarea id="book-description" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-blue-500 resize-none" rows="3" placeholder="KitabÄ±n kÄ±sa aÃ§Ä±klamasÄ±nÄ± girin"></textarea>
          </div>
          <div>
            <label class="block text-sm font-semibold text-gray-700 mb-2">Kapak GÃ¶rseli URL *</label>
            <input type="text" id="book-cover-image" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-blue-500" placeholder="Kapak gÃ¶rseli URL'si">
          </div>
          <div class="flex gap-3 pt-4">
            <button type="submit" class="flex-1 bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 rounded transition">
              <i class="fas fa-save mr-2"></i> Kitap Ekle
            </button>
            <button type="button" onclick="closeAddBookModal()" class="flex-1 bg-gray-300 hover:bg-gray-400 text-gray-800 font-semibold py-2 rounded transition">
              Ä°ptal
            </button>
          </div>
        </form>
      </div>
    </div>
            </button>
          </div>
        </form>
      </div>
    </div>

    <script src="js/main.js"></script>
    <script>
      document.addEventListener("DOMContentLoaded", () => {
        checkAdminAuth();
        loadAdminInfo();
        loadDashboardStats();
        loadBooks();
        loadUsers();
      });

      function showSection(sectionId) {
        document.getElementById("section-dashboard").classList.add("hidden");
        document.getElementById("section-books").classList.add("hidden");
        document.getElementById("section-users").classList.add("hidden");

        document
          .getElementById("section-" + sectionId)
          .classList.remove("hidden");

        const titles = {
          dashboard: "Genel BakÄ±ÅŸ",
          books: "Kitap YÃ¶netimi",
          users: "KullanÄ±cÄ± YÃ¶netimi",
          moderation: "Ä°Ã§erik Moderasyonu",
        };
        document.getElementById("page-title").innerText = titles[sectionId];

        document.querySelectorAll("aside nav button").forEach((btn) => {
          btn.classList.remove("active-nav", "bg-slate-800");
        });
        document.getElementById("btn-" + sectionId).classList.add("active-nav");
      }

      function checkAdminAuth() {
        const token = localStorage.getItem("token");
        if (!token) {
          window.location.href = "login.html";
        }
      }

      async function loadAdminInfo() {
        try {
          const res = await authFetch("/auth/me");
          if (!res) return;
          const user = await res.json();
          document.getElementById("admin-name").innerText =
            user.name || user.username || "YÃ¶netici";
          document.getElementById("admin-email").innerText = user.email || "";
        } catch (error) {
          const name = localStorage.getItem("user_name") || "YÃ¶netici";
          document.getElementById("admin-name").innerText = name;
          document.getElementById("admin-email").innerText = "";
        }
      }

      async function loadDashboardStats() {
        try {
          const response = await authFetch("/admin/stats");
          if (!response) return;
          const data = await response.json();

          document.getElementById("stat-books").innerText = data.books || 0;
          document.getElementById("stat-users").innerText = data.users || 0;
          document.getElementById("stat-posts").innerText = data.posts || 0;
          document.getElementById("stat-comments").innerText =
            data.comments || 0;
        } catch (error) {
          console.error(error);
        }
      }

      async function loadBooks() {
        const tbody = document.getElementById("books-table-body");
        try {
          const response = await authFetch("/books");
          if (!response) return;
          const books = await response.json();

          tbody.innerHTML = "";
          if (books.length === 0) {
            tbody.innerHTML =
              '<tr><td colspan="5" class="p-4 text-center text-gray-500">KÃ¼tÃ¼phanede kitap yok.</td></tr>';
            return;
          }

          books.forEach((book) => {
            const coverHtml = book.cover_image
              ? `<img src="${book.cover_image}" alt="${book.title}" class="w-12 h-16 object-cover rounded">`
              : '<div class="w-12 h-16 bg-gray-200 rounded flex items-center justify-center text-gray-400 text-xs"><i class="fas fa-book"></i></div>';

            const authorName =
              book.author ||
              (book.Authors && book.Authors.length > 0
                ? book.Authors.map((a) => a.full_name).join(", ")
                : "Bilinmeyen");

            const html = `
                    <tr class="hover:bg-gray-50 transition border-b">
                        <td class="p-4">${coverHtml}</td>
                        <td class="p-4 text-gray-500">#${book.book_id}</td>
                        <td class="p-4 font-semibold text-gray-800">${book.title}</td>
                        <td class="p-4 text-gray-600">${authorName}</td>
                        <td class="p-4"><span class="bg-blue-100 text-blue-800 px-2 py-1 rounded text-xs font-semibold">${book.category}</span></td>
                        <td class="p-4 text-center">
                            <button onclick="kitapSil(${book.book_id})" class="text-red-500 hover:text-red-700 mx-1 p-2 transition" title="Sil">
                                <i class="fas fa-trash-alt"></i>
                            </button>
                        </td>
                    </tr>`;
            tbody.innerHTML += html;
          });
        } catch (error) {
          console.error(error);
        }
      }

      function searchBooksAdmin() {
        const searchInput = document.getElementById("book-search-admin");
        const query = (searchInput?.value || "").trim().toLowerCase();
        const tbody = document.getElementById("books-table-body");
        const rows = tbody.querySelectorAll("tr");

        rows.forEach((row) => {
          const titleCell = row.querySelector("td:nth-child(3)");
          const authorCell = row.querySelector("td:nth-child(4)");
          const categoryCell = row.querySelector("td:nth-child(5)");

          if (!titleCell || !authorCell) {
            row.style.display = "table-row";
            return;
          }

          const title = titleCell.textContent.toLowerCase();
          const author = authorCell.textContent.toLowerCase();
          const category = categoryCell.textContent.toLowerCase();

          if (
            title.includes(query) ||
            author.includes(query) ||
            category.includes(query)
          ) {
            row.style.display = "table-row";
          } else {
            row.style.display = "none";
          }
        });
      }

      async function loadUsers() {
        const tbody = document.getElementById("users-table-body");
        try {
          const response = await authFetch("/admin/users");
          if (!response) return;

          const users = await response.json();
          tbody.innerHTML = "";

          if (!Array.isArray(users) || users.length === 0) {
            tbody.innerHTML =
              '<tr><td colspan="5" class="p-4 text-center text-gray-500">KayÄ±tlÄ± kullanÄ±cÄ± bulunamadÄ±.</td></tr>';
            return;
          }

          users.forEach((user) => {
            const name = user.name || user.username;
            const initials = (name || "?").substring(0, 2).toUpperCase();
            const role = user.role || "-";
            const email = user.email || "-";
            const roleOptions = ["user", "admin"]
              .map(
                (r) =>
                  `<option value="${r}" ${
                    r === role ? "selected" : ""
                  }>${r}</option>`
              )
              .join("");

            const row = `
              <tr class="hover:bg-gray-50 transition border-b">
                <td class="p-4 border-b flex items-center gap-3">
                  <div class="w-8 h-8 bg-indigo-100 rounded-full flex items-center justify-center text-indigo-600 font-bold">${initials}</div>
                  <span class="font-semibold">${name}</span>
                </td>
                <td class="p-4 border-b text-gray-500">${email}</td>
                <td class="p-4 border-b">
                  <select class="border rounded px-2 py-1 text-sm" onchange="updateUserRole(${
                    user.user_id
                  }, this.value)">
                    ${roleOptions}
                  </select>
                </td>
                <td class="p-4 border-b text-gray-500">Aktif</td>
                <td class="p-4 border-b text-center flex gap-2 justify-center">
                  <button onclick="deleteUser(${
                    user.user_id
                  }, '${name}')" class="text-red-500 hover:text-red-700 p-2 transition" title="Sil">
                    <i class="fas fa-trash-alt"></i>
                  </button>
                </td>
              </tr>`;
            tbody.innerHTML += row;
          });
        } catch (error) {
          console.error(error);
          tbody.innerHTML =
            '<tr><td colspan="5" class="p-4 text-center text-red-500">KullanÄ±cÄ±lar yÃ¼klenemedi.</td></tr>';
        }
      }

      async function updateUserRole(userId, role) {
        try {
          const response = await authFetch(`/admin/users/${userId}/role`, {
            method: "PUT",
            body: JSON.stringify({ role }),
          });

          if (!response) return;
          if (!response.ok) {
            const data = await response.json();
            alert(data.error || "Rol gÃ¼ncellenemedi.");
            loadUsers();
            return;
          }

          loadUsers();
        } catch (error) {
          console.error(error);
          alert("Rol gÃ¼ncellenemedi.");
          loadUsers();
        }
      }

      async function deleteUser(userId, userName) {
        if (
          !confirm(
            `"${userName}" kullanÄ±cÄ±sÄ±nÄ± silmek istediÄŸinizden emin misiniz? Bu iÅŸlem geri alÄ±namaz.`
          )
        ) {
          return;
        }

        try {
          const response = await authFetch(`/admin/users/${userId}`, {
            method: "DELETE",
          });

          if (!response) return;
          if (!response.ok) {
            const data = await response.json();
            alert(data.error || "KullanÄ±cÄ± silinemedi.");
            return;
          }

          alert("KullanÄ±cÄ± baÅŸarÄ±yla silindi.");
          loadUsers();
        } catch (error) {
          console.error(error);
          alert("KullanÄ±cÄ± silinirken hata oluÅŸtu.");
        }
      }

      async function kitapEkleModal() {
        const modal = document.getElementById("add-book-modal");
        modal.classList.remove("hidden");
        modal.style.display = "flex";
        document.body.style.overflow = "hidden";
        document.getElementById("add-book-form").reset();
        setTimeout(() => document.getElementById("book-title").focus(), 0);
      }

      function closeAddBookModal() {
        const modal = document.getElementById("add-book-modal");
        modal.classList.add("hidden");
        modal.style.display = "none";
        document.body.style.overflow = "auto";
        document.getElementById("add-book-form").reset();
      }

      document.getElementById("add-book-form").addEventListener("submit", async (e) => {
        e.preventDefault();
        
        const title = document.getElementById("book-title").value.trim();
        const authorInput = document.getElementById("book-author").value.trim();
        const authors = authorInput
          ? authorInput.split(",")
              .map((s) => s.trim())
              .filter((s) => s.length > 0)
          : [];
        const category = document.getElementById("book-category").value.trim();
        const publisher = document.getElementById("book-publisher").value.trim();
        const pageCount = parseInt(document.getElementById("book-page-count").value) || 0;
        const description = document.getElementById("book-description").value.trim();
        const coverImage = document.getElementById("book-cover-image").value.trim();

        if (!title) {
          alert("LÃ¼tfen kitap adÄ±nÄ± girin!");
          return;
        }

        const submitBtn = document.querySelector("#add-book-form button[type='submit']");
        const originalText = submitBtn.innerHTML;
        submitBtn.disabled = true;
        submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Ekleniyor...';

        try {
          const response = await authFetch("/books/add", {
            method: "POST",
            body: JSON.stringify({
              title: title,
              // prefer array of authors; backend supports both
              authors: authors,
              author: authors.length === 0 ? (authorInput || null) : null,
              category: category || null,
              publisher: publisher || null,
              page_count: pageCount,
              description: description || null,
              cover_image: coverImage || null,
            }),
          });

          const data = await response.json();

          if (response.ok) {
            alert("Kitap baÅŸarÄ±yla eklendi! ðŸŽ‰");
            closeAddBookModal();
            loadBooks();
            loadDashboardStats();
          } else {
            alert("Hata: " + (data.error || "Bilinmeyen hata"));
          }
        } catch (error) {
          console.error("BaÄŸlantÄ± HatasÄ±:", error);
          alert("Sunucuya baÄŸlanÄ±lamadÄ±. LÃ¼tfen daha sonra tekrar deneyin.");
        } finally {
          submitBtn.disabled = false;
          submitBtn.innerHTML = originalText;
        }
      });

      document.addEventListener("keydown", (e) => {
        if (e.key === "Escape") {
          closeAddBookModal();
        }
      });

      async function kitapSil(id) {
        if (!confirm("Silmek istediÄŸinize emin misiniz?")) return;
        try {
          const response = await authFetch(`/books/${id}`, {
            method: "DELETE",
          });
          if (response.ok) {
            loadBooks();
            loadDashboardStats();
          } else {
            alert("Silinemedi.");
          }
        } catch (error) {
          console.error(error);
        }
      }

      function logout() {
        if (confirm("Ã‡Ä±kÄ±ÅŸ yapmak istediÄŸinize emin misiniz?")) {
          localStorage.clear();
          window.location.href = "login.html";
        }
      }
    </script>
  </body>
</html>
